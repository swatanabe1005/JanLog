<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JanLog - 麻雀成績・清算管理</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="min-h-screen text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-6 max-w-6xl">

        <!-- ヘッダー -->
        <header class="mb-6 flex flex-col md:flex-row justify-between items-center bg-white p-4 rounded-xl shadow-sm">
            <div class="flex items-center mb-4 md:mb-0">
                <div class="bg-indigo-600 text-white p-2 rounded-lg mr-3">
                    <i class="fa-solid fa-layer-group text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-800 tracking-tight">JanLog</h1>
                    <p class="text-xs text-gray-500">麻雀成績・清算管理</p>
                </div>
            </div>
            <div class="flex items-center space-x-4 text-sm">
                <div class="text-right hidden sm:block">
                    <p class="text-gray-500">User ID</p>
                    <p id="userIdDisplay" class="font-mono font-bold text-gray-700">Loading...</p>
                </div>
                <button onclick="toggleSettings()"
                    class="flex items-center space-x-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg transition text-gray-700 font-medium">
                    <i class="fa-solid fa-gear"></i>
                    <span>ルール設定</span>
                </button>
            </div>
        </header>

        <!-- ルール設定モーダル (初期非表示) -->
        <div id="settingsPanel" class="hidden mb-6 card p-6 border-l-4 border-indigo-500 animate-fade-in-down">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fa-solid fa-sliders mr-2"></i> ルール・レート設定
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4">
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">持ち点 (全員)</label>
                    <div class="relative">
                        <input type="number" id="settingStartScore" value="25000"
                            class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 bg-gray-50 font-mono"
                            onchange="saveSettingsToLocal()">
                        <span class="absolute right-3 top-2 text-gray-400 text-sm">点</span>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">返し点 (原点)</label>
                    <div class="relative">
                        <input type="number" id="settingReturnScore" value="25000"
                            class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 bg-gray-50 font-mono"
                            onchange="saveSettingsToLocal()">
                        <span class="absolute right-3 top-2 text-gray-400 text-sm">点</span>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">ウマ (順位点)</label>
                    <select id="settingUma"
                        class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 bg-gray-50"
                        onchange="saveSettingsToLocal()">
                        <option value="10-30">10 - 30 (ゴットー)</option>
                        <option value="10-20">10 - 20 (ワンツー)</option>
                        <option value="5-10">5 - 10 (ウマナリ)</option>
                        <option value="0-0">なし</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">レート (1000点あたり)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2 text-gray-400 text-sm">¥</span>
                        <input type="number" id="settingRate" value="50"
                            class="w-full pl-6 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 bg-gray-50 font-mono"
                            onchange="saveSettingsToLocal()">
                    </div>
                    <p class="text-xs text-gray-400 mt-1">※50=点5, 100=点ピン</p>
                </div>
                <!-- 場代総額 -->
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">場代総額 (日額)</label>
                    <div class="relative">
                        <span class="absolute left-3 top-2 text-gray-400 text-sm">¥</span>
                        <input type="number" id="settingFee" value="1000"
                            class="w-full pl-6 p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 bg-gray-50 font-mono"
                            onchange="saveSettingsToLocal()">
                    </div>
                    <p class="text-xs text-gray-400 mt-1">※総額を全員で割勘清算します。</p>
                </div>
                <!-- NEW: 場代支払い者 (立て替え者) -->
                <div>
                    <label class="block text-xs font-semibold text-gray-500 uppercase mb-1">場代支払い者 (立て替え)</label>
                    <select id="settingFeePayer"
                        class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 bg-gray-50"
                        onchange="saveSettingsToLocal()">
                        <!-- JSでオプションを生成 -->
                    </select>
                    <p class="text-xs text-gray-400 mt-1">※代表して払った人を選択。</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <!-- 左カラム：入力・計算 (8/12) -->
            <div class="lg:col-span-8 space-y-6">

                <!-- スコア入力パネル -->
                <div class="card p-6">
                    <div class="flex justify-between items-center mb-6 border-b pb-4">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center">
                            <i class="fa-solid fa-pen-to-square mr-2 text-indigo-500"></i> 局スコア入力
                        </h2>
                        <button onclick="resetInputs()" class="text-sm text-gray-500 hover:text-red-500 transition">
                            <i class="fa-solid fa-rotate-right"></i> 入力リセット
                        </button>
                    </div>

                    <div class="grid grid-cols-1 gap-4" id="playerInputs">
                        <!-- JSで入力行を生成 -->
                    </div>

                    <!-- 合計点数チェック表示 -->
                    <div class="mt-4 flex justify-between items-center text-sm">
                        <div id="totalScoreDisplay" class="font-mono text-gray-500">合計: 0点</div>
                        <div id="checkMessage" class="text-red-500 font-bold"></div>
                    </div>

                    <div class="mt-6 pt-4 border-t flex flex-col sm:flex-row gap-4">
                        <button onclick="calculate()"
                            class="flex-1 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow hover:bg-indigo-700 transition flex justify-center items-center">
                            <i class="fa-solid fa-calculator mr-2"></i> 計算する
                        </button>
                    </div>
                </div>

                <!-- 計算結果プレビュー -->
                <div id="resultPreview"
                    class="hidden card p-6 bg-gradient-to-br from-gray-900 to-gray-800 text-white border-l-4 border-yellow-400">
                    <h3 class="text-lg font-bold mb-4 flex items-center text-yellow-400">
                        <i class="fa-solid fa-flag-checkered mr-2"></i> 局の結果 <span
                            class="text-xs ml-3 text-gray-400">(場代割勘前の収支)</span>
                    </h3>
                    <div id="resultList" class="space-y-3 mb-6">
                        <!-- JSで結果生成 -->
                    </div>
                    <button onclick="saveSession()"
                        class="w-full bg-yellow-500 text-gray-900 font-bold py-3 rounded-lg hover:bg-yellow-400 transition shadow-lg">
                        <i class="fa-solid fa-save mr-2"></i> この結果を記録する
                    </button>
                </div>

                <!-- 履歴リスト -->
                <div class="card p-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-clock-rotate-left mr-2 text-gray-500"></i> 対局履歴
                    </h2>
                    <p class="text-gray-500 text-sm mb-4" id="loadingMessage">データをロード中...</p>
                    <div id="historyList" class="space-y-4">
                        <!-- JSで履歴生成 -->
                    </div>
                </div>
            </div>

            <!-- 右カラム：本日の集計 (4/12) -->
            <div class="lg:col-span-4 space-y-6">
                <!-- トータル成績パネル -->
                <div class="card p-6 sticky top-6 border-t-4 border-indigo-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center justify-between">
                        <span><i class="fa-solid fa-chart-simple mr-2 text-indigo-500"></i> 本日の成績</span>
                        <span
                            class="text-xs font-normal bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full">Total</span>
                    </h2>

                    <p class="text-xs text-gray-500 mb-2">対局の純粋なスコア収支です（場代含まず）。</p>
                    <p class="text-xs text-red-500 mb-4 font-bold" id="dailyFeeMessage"></p>


                    <div id="dailyTotalList" class="space-y-4">
                        <p class="text-gray-400 text-sm text-center py-4">データがありません</p>
                    </div>

                    <div class="mt-6 pt-4 border-t text-xs text-gray-400">
                        <p>※ ポイント = (素点 - 返し点)/1000 + ウマ + オカ</p>
                        <p>※ 収支 = ポイント × レート (場代は含みません)</p>
                    </div>
                </div>

                <!-- 清算サマリーパネル -->
                <div class="card p-6 border-l-4 border-green-500">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fa-solid fa-money-bill-transfer mr-2 text-green-500"></i> 清算サマリー
                    </h2>
                    <p class="text-sm text-gray-500 mb-4">場代を含めた最終的な支払い指示です。</p>
                    <div id="settlementSummary" class="space-y-3">
                        <p class="text-gray-400 text-sm text-center py-2">清算するデータがありません</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // 環境設定
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-janlog-app-id';
        
        import { initializeApp } from "firebase/app";
        import { getAnalytics } from "firebase/analytics";
        const firebaseConfig = {
            apiKey: "AIzaSyDvBXs3yigvf6-hCsZdwMKT4qGeFPXdCcs",
            authDomain: "janlog.firebaseapp.com",
            projectId: "janlog",
            storageBucket: "janlog.firebasestorage.app",
            messagingSenderId: "398225426396",
            appId: "1:398225426396:web:f03d1255d06c2fec5ff119",
            measurementId: "G-K7CPJ7TSTN"
        };

        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            // Firebase設定の最低限のチェック (apiKeyがあればFirebaseの初期化を試みる)
            if (!firebaseConfig.apiKey) {
                console.warn("Firebase Config does not contain an API Key. Firestore will be disabled.");
                firebaseConfig = null; // 無効な設定としてマーク
            }
        } catch (e) {
            console.error("Failed to parse __firebase_config:", e);
            firebaseConfig = null; // パースエラー
        }

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId;
        let isFirebaseActive = !!firebaseConfig; // Firebaseが使用可能かどうかのフラグ
        let currentCalculatedData = null; // 計算結果の一時保存用

        // デフォルトプレイヤー
        const defaultPlayers = ["Aさん", "Bさん", "Cさん", "Dさん"];
        let players = loadPlayersFromLocal() || defaultPlayers.map(name => ({ name, score: "" }));

        // ------------------------------------
        // 初期化処理
        // ------------------------------------
        window.onload = async () => {
            loadSettingsFromLocal(); // 設定読み込み
            renderPlayerInputs();
            // Firebaseが有効な場合のみ初期化を試みる
            if (isFirebaseActive) {
                await initFirebase();
            } else {
                // Firebaseが無効な場合、ユーザーIDをランダムに設定し、UIを更新
                userId = crypto.randomUUID();
                document.getElementById('userIdDisplay').textContent = "Local Only";
                document.getElementById('loadingMessage').textContent = "クラウド同期無効。データは保存されません。";
            }
        };

        // UI操作関数
        window.toggleSettings = () => {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('hidden');
        };

        window.updatePlayerName = (index, val) => {
            players[index].name = val;
            savePlayersToLocal();
            renderFeePayerOptions();
        };

        window.updatePlayerScore = (index, val) => {
            players[index].score = val;
            updateTotalScoreDisplay();
        };

        window.resetInputs = () => {
            players.forEach(p => p.score = "");
            renderPlayerInputs();
            document.getElementById('resultPreview').classList.add('hidden');
            updateTotalScoreDisplay();
        };

        function renderPlayerInputs() {
            const container = document.getElementById('playerInputs');
            container.innerHTML = players.map((p, i) => `
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 flex items-center justify-center bg-gray-200 rounded-full text-xs font-bold text-gray-600">
                        ${['東', '南', '西', '北'][i]}
                    </div>
                    <input type="text" value="${p.name}" placeholder="名前" 
                        onchange="updatePlayerName(${i}, this.value)"
                        class="w-1/3 p-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 transition text-sm font-medium">
                    <input type="number" value="${p.score}" placeholder="点数" step="100"
                        oninput="updatePlayerScore(${i}, this.value)"
                        class="flex-1 p-2 border border-gray-300 rounded-lg focus:outline-none focus:border-indigo-500 transition text-sm font-mono text-right">
                    <span class="text-gray-500 text-sm w-4">点</span>
                </div>
            `).join('');
            updateTotalScoreDisplay();
            renderFeePayerOptions();
        }

        // NEW: 場代支払い者ドロップダウンのオプションを生成・設定
        function renderFeePayerOptions() {
            const select = document.getElementById('settingFeePayer');
            if (!select) return;

            // ローカルストレージから最後に選択されていた支払い者名を取得
            const savedPayer = localStorage.getItem('janlog_fee_payer_name') || '__everyone__';

            let optionsHtml = '<option value="__everyone__">全員で割勘 (立て替えなし)</option>';

            // 現在のプレイヤー名リストからオプションを生成
            players.forEach(p => {
                // プレイヤー名が変更される可能性を考慮し、値も名前とする
                const isSelected = p.name === savedPayer;
                optionsHtml += `<option value="${p.name}" ${isSelected ? 'selected' : ''}>${p.name}</option>`;
            });

            select.innerHTML = optionsHtml;
            // savedPayerが現在のプレイヤーリストに含まれない場合、デフォルトに戻る
            if (!select.value) {
                select.value = '__everyone__';
            }
        }


        function updateTotalScoreDisplay() {
            const total = players.reduce((sum, p) => sum + (parseInt(p.score) || 0), 0);
            const display = document.getElementById('totalScoreDisplay');
            const startScore = parseInt(document.getElementById('settingStartScore').value) || 25000;
            const targetTotal = startScore * 4;

            display.textContent = `合計: ${total.toLocaleString()}点`;

            // 簡易チェック
            const diff = total - targetTotal;
            const msg = document.getElementById('checkMessage');
            if (total === 0 && players.every(p => !p.score)) {
                msg.textContent = "";
            } else if (diff === 0) {
                msg.textContent = "OK";
                msg.className = "text-green-500 font-bold text-sm";
            } else {
                console.error(`点数合計のズレ: ${diff}`);
                msg.textContent = `ズレ: ${diff > 0 ? '+' : ''}${diff}`;
                msg.className = "text-red-500 font-bold text-sm";
            }
        }

        // ------------------------------------
        // 計算ロジック (局スコア計算)
        // ------------------------------------
        window.calculate = () => {
            // 設定値取得
            const startScore = parseInt(document.getElementById('settingStartScore').value) || 25000;
            const returnScore = parseInt(document.getElementById('settingReturnScore').value) || 25000;
            const umaStr = document.getElementById('settingUma').value; // "10-30"
            const rate = parseInt(document.getElementById('settingRate').value) || 0;
            const fee = parseInt(document.getElementById('settingFee').value) || 0;
            const feePayer = document.getElementById('settingFeePayer').value || '__everyone__'; // NEW: 支払い者

            // ウマの値を解析 [3位・2位のウマ, 4位・1位のウマ]
            const [uma3_2, uma4_1] = umaStr.split('-').map(Number);

            // 入力バリデーション
            const scores = players.map(p => parseInt(p.score));
            if (scores.some(isNaN) || scores.length !== 4) {
                console.error("全員の点数を入力してください");
                // カスタムアラートに置き換えることが推奨
                return;
            }

            const totalScore = scores.reduce((a, b) => a + b, 0);
            if (Math.abs(totalScore - startScore * 4) > 100) {
                console.warn(`点数合計のズレが大きいです。計算を続行します。`);
            }

            // プレイヤーオブジェクト作成（計算用）
            let results = players.map((p, i) => ({
                name: p.name,
                rawScore: parseInt(p.score) || 0,
                originalIndex: i
            }));

            // 順位決定 (同点は上家優先ロジック: originalIndexが小さい方が優先)
            results.sort((a, b) => {
                if (b.rawScore !== a.rawScore) return b.rawScore - a.rawScore;
                return a.originalIndex - b.originalIndex;
            });

            // 順位付与
            results.forEach((r, rankIdx) => r.rank = rankIdx + 1);

            // オカ = (返し点 - 持ち点) * 4
            const okaPoint = (returnScore - startScore) * 4 / 1000;

            results.forEach(r => {
                // 素点計算: (最終点数 - 返し点) / 1000
                let point = (r.rawScore - returnScore) / 1000;
                let umaOkaPoint = 0;

                // ウマ・オカ計算
                if (r.rank === 1) {
                    umaOkaPoint += okaPoint; // オカ全取り
                    umaOkaPoint += uma4_1; // 1位のウマ
                } else if (r.rank === 2) {
                    umaOkaPoint += uma3_2; // 2位のウマ
                } else if (r.rank === 3) {
                    umaOkaPoint -= uma3_2; // 3位のウマ
                } else if (r.rank === 4) {
                    umaOkaPoint -= uma4_1; // 4位のウマ
                }

                // ポイント合計
                r.point = point + umaOkaPoint;

                // 金額計算 (場代清算前)
                r.moneyPreFee = Math.round(r.point * rate);
            });

            // 1. ポイントの端数調整 (合計が0になるように)
            const totalPoint = results.reduce((sum, r) => sum + r.point, 0);
            if (Math.abs(totalPoint) > 0.01) {
                // 誤差をトップから引く（または足す）
                const topPlayer = results.find(r => r.rank === 1);
                if (topPlayer) {
                    topPlayer.point = Math.round((topPlayer.point - totalPoint) * 10) / 10;
                    topPlayer.moneyPreFee = Math.round(topPlayer.point * rate); // 金額再計算
                }
            }

            // finalMoneyは場代清算前の収支とする。
            let finalResults = results.map(r => ({ ...r, finalMoney: r.moneyPreFee }));


            currentCalculatedData = {
                createdAt: new Date().toISOString(), // Firebase無効時のフォールバック
                results: finalResults,
                // NEW: feePayerを設定に含める
                settings: { startScore, returnScore, uma: umaStr, rate, fee, feePayer }
            };

            // Firebase無効の場合、履歴リストがないため集計を更新
            if (!isFirebaseActive) {
                calculateDailyTotal([currentCalculatedData]); // 現在の局のみを渡す
            }

            displayResultPreview(finalResults);
        };

        function displayResultPreview(results) {
            const container = document.getElementById('resultList');

            container.innerHTML = results.map((r, i) => {
                const moneyClass = r.finalMoney >= 0 ? 'text-blue-300' : 'text-red-300';
                const moneySign = r.finalMoney > 0 ? '+' : '';
                const pointSign = r.point > 0 ? '+' : '';

                return `
                <div class="flex items-center justify-between p-3 rounded-lg ${i === 0 ? 'bg-white bg-opacity-10' : 'bg-white bg-opacity-5'}">
                    <div class="flex items-center">
                        <div class="w-6 h-6 rounded flex items-center justify-center font-bold text-xs mr-3 ${r.rank === 1 ? 'bg-yellow-500 text-black' : 'bg-gray-600 text-white'}">
                            ${r.rank}
                        </div>
                        <div>
                            <div class="font-bold text-sm">${r.name}</div>
                            <div class="text-xs text-gray-400">${r.rawScore.toLocaleString()}点</div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-lg ${r.point > 0 ? 'text-yellow-400' : 'text-gray-300'}">${pointSign}${r.point.toFixed(1)}</div>
                        <div class="text-xs ${moneyClass}">${moneySign}${r.finalMoney.toLocaleString()}円</div>
                    </div>
                </div>
            `}).join('');

            document.getElementById('resultPreview').classList.remove('hidden');
        }

        // ------------------------------------
        // データ保存・読み込み (Firestore/Local)
        // ------------------------------------

        // ローカルストレージ設定保存
        window.saveSettingsToLocal = () => {
            const settings = {
                startScore: document.getElementById('settingStartScore').value,
                returnScore: document.getElementById('settingReturnScore').value,
                uma: document.getElementById('settingUma').value,
                rate: document.getElementById('settingRate').value,
                fee: document.getElementById('settingFee').value,
                feePayer: document.getElementById('settingFeePayer').value // NEW: 支払い者
            };
            localStorage.setItem('janlog_settings', JSON.stringify(settings));
            // NEW: 支払い者名をローカルストレージにも保存 (UI反映用)
            localStorage.setItem('janlog_fee_payer_name', settings.feePayer);
            // 設定変更後、集計を再計算
            if (isFirebaseActive && userId) setupHistoryListener();
        };

        function loadSettingsFromLocal() {
            const s = JSON.parse(localStorage.getItem('janlog_settings'));
            if (s) {
                document.getElementById('settingStartScore').value = s.startScore;
                document.getElementById('settingReturnScore').value = s.returnScore;
                document.getElementById('settingUma').value = s.uma;
                document.getElementById('settingRate').value = s.rate;
                if (s.fee !== undefined) {
                    document.getElementById('settingFee').value = s.fee;
                } else {
                    document.getElementById('settingFee').value = 0;
                }
                // NEW: 支払い者設定はlocalStorage.getItem('janlog_fee_payer_name')として参照される
                if (s.feePayer) {
                    localStorage.setItem('janlog_fee_payer_name', s.feePayer);
                }
            }
        }

        function savePlayersToLocal() {
            const pData = players.map(p => p.name);
            localStorage.setItem('janlog_players', JSON.stringify(pData));
        }

        function loadPlayersFromLocal() {
            const pData = JSON.parse(localStorage.getItem('janlog_players'));
            if (pData && Array.isArray(pData)) {
                return pData.map(name => ({ name, score: "" }));
            }
            return null;
        }

        async function initFirebase() {
            // Firebaseが有効な場合のみ実行
            if (!isFirebaseActive) return;

            try {
                // Firestoreのデバッグログを有効化
                setLogLevel('Debug');

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // 匿名認証/カスタムトークン認証
                let userCredential;
                if (initialAuthToken) {
                    userCredential = await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    userCredential = await signInAnonymously(auth);
                }

                userId = userCredential.user.uid;
                document.getElementById('userIdDisplay').textContent = userId.substring(0, 6) + '...';
                setupHistoryListener();

            } catch (e) {
                // ここでエラーをキャッチし、Firebaseを無効化
                console.error("Firebase Init Error (Falling back to local mode):", e);
                isFirebaseActive = false;
                userId = crypto.randomUUID(); // ランダムIDを生成してローカル動作をサポート
                document.getElementById('userIdDisplay').textContent = "Sync Failed";
                document.getElementById('loadingMessage').textContent = "クラウド同期に失敗しました。ローカルモードで動作します。";
            }
        }

        window.saveSession = async () => {
            if (!isFirebaseActive) {
                // Firebaseが無効な場合、カスタムアラートを表示
                console.warn("Firebase is not active. Cannot save to cloud.");
                // alert()の代わりにconsole.logを使用
                console.log("同期失敗: クラウドにデータを保存できません。");
                return;
            }

            if (!userId || !currentCalculatedData) {
                console.error("ユーザーIDまたは計算データがありません。");
                return;
            }

            try {
                const path = `artifacts/${appId}/users/${userId}/sessions`;
                currentCalculatedData.createdAt = serverTimestamp(); // サーバータイムスタンプを設定

                await addDoc(collection(db, path), currentCalculatedData);

                resetInputs();
                console.log("記録しました！");
            } catch (e) {
                console.error("Save Error", e);
                console.error("保存に失敗しました");
            }
        };

        window.deleteSession = async (id) => {
            if (!isFirebaseActive) {
                console.warn("Firebase is not active. Cannot delete from cloud.");
                // alert()の代わりにconsole.logを使用
                console.log("同期失敗: クラウドのデータを削除できません。");
                return;
            }

            // カスタムモーダルに置き換えるべきですが、ここでは便宜上confirmを使用
            if (!window.confirm("この記録を削除しますか？")) return;
            try {
                const path = `artifacts/${appId}/users/${userId}/sessions`;
                await deleteDoc(doc(db, path, id));
                console.log("削除しました。");
            } catch (e) {
                console.error("Delete Error", e);
                console.error("削除に失敗しました。");
            }
        };

        function setupHistoryListener() {
            if (!isFirebaseActive || !userId) {
                console.log("FirebaseまたはUserIDが未定義のため、履歴リスナーを設定できません。");
                return;
            }
            const path = `artifacts/${appId}/users/${userId}/sessions`;
            const q = query(collection(db, path));

            const listContainer = document.getElementById('historyList');
            const loadingMsg = document.getElementById('loadingMessage');

            onSnapshot(q, (snapshot) => {
                loadingMsg.style.display = 'none';

                let allSessions = [];

                if (snapshot.empty) {
                    listContainer.innerHTML = '<p class="text-center text-gray-400 py-4">履歴がありません</p>';
                } else {
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        allSessions.push({ id: doc.id, ...data }); // IDを含めて集計用に保持
                    });

                    // 日付順にソート (降順)
                    allSessions.sort((a, b) => {
                        // タイムスタンプオブジェクトをDateに変換して比較
                        const timeA = a.createdAt && typeof a.createdAt.toDate === 'function' ? a.createdAt.toDate().getTime() : 0;
                        const timeB = b.createdAt && typeof b.createdAt.toDate === 'function' ? b.createdAt.toDate().getTime() : 0;
                        return timeB - timeA;
                    });

                    // 履歴UIのレンダリング
                    listContainer.innerHTML = allSessions.map(({ id, ...data }) => {
                        const date = data.createdAt && typeof data.createdAt.toDate === 'function' ? new Date(data.createdAt.toDate()) : new Date();
                        const dateStr = date.toLocaleString('ja-JP', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });

                        const settings = data.settings || {};
                        const rateStr = settings.rate ? `¥${settings.rate.toLocaleString()}/1K` : 'レート不明';
                        const okaValue = settings.returnScore && settings.startScore ? (settings.returnScore - settings.startScore) * 4 / 1000 : 0;
                        const umaOkaStr = `ウマ:${settings.uma || 'N/A'}, オカ:${okaValue.toFixed(0)}P`;
                        // 場代総額と支払い者を履歴に表示
                        const feeStr = settings.fee && settings.fee > 0 ?
                            `場代: ¥${parseInt(settings.fee).toLocaleString()} (${settings.feePayer === '__everyone__' ? '割勘' : settings.feePayer + '立替'})` : '';


                        return `
                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                                <div class="flex justify-between items-center mb-2 pb-2">
                                    <div class="text-xs text-gray-500 font-mono">${dateStr}</div>
                                    <button onclick="deleteSession('${id}')" class="text-xs text-red-400 hover:text-red-600">削除</button>
                                </div>

                                <div class="flex justify-between text-xs text-gray-600 mb-3 p-2 bg-indigo-50 rounded">
                                    <span class="font-bold">${rateStr}</span>
                                    <span>${umaOkaStr}</span>
                                    ${feeStr ? `<span class="truncate max-w-[100px] sm:max-w-full">${feeStr}</span>` : ''}
                                </div>

                                <div class="space-y-1">
                                    ${data.results.sort((a, b) => a.rank - b.rank).map(r => {
                            const ptColor = r.point > 0 ? 'text-green-600' : (r.point < 0 ? 'text-red-500' : 'text-gray-500');
                            const moneyColor = r.moneyPreFee > 0 ? 'text-blue-600' : (r.moneyPreFee < 0 ? 'text-red-600' : 'text-gray-500');
                            const displayMoney = Math.round(r.moneyPreFee); // 履歴では場代割勘前の金額を丸めて表示

                            return `
                                        <div class="flex justify-between text-sm items-center">
                                            <div class="flex items-center w-24">
                                                <span class="inline-block w-4 text-center text-xs font-bold ${r.rank === 1 ? 'text-yellow-600' : ''}">${r.rank}</span>
                                                <span class="truncate ml-1 font-medium">${r.name}</span>
                                            </div>
                                            <div class="text-gray-500 text-xs w-16 text-right">${r.rawScore.toLocaleString()}</div>
                                            <div class="font-bold w-12 text-right ${ptColor}">${r.point > 0 ? '+' : ''}${r.point.toFixed(1)}</div>
                                            <div class="text-xs font-bold w-16 text-right ${moneyColor}">${displayMoney > 0 ? '+' : ''}${displayMoney.toLocaleString()}円</div>
                                        </div>
                                        `
                        }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // 本日の集計を実行
                calculateDailyTotal(allSessions.map(({ id, ...rest }) => rest));
            });
        }

        // 清算指示を生成し、UIに表示する
        function renderSettlementSummary(playerStats) {
            let settlements = [];

            // 収支がマイナス（支払う側）とプラス（受け取る側）のリストを作成
            // ここでは p.finalMoney (場代調整後の金額) を使用します
            let payers = Object.values(playerStats)
                .filter(p => p.finalMoney < 0)
                .map(p => ({
                    name: p.name,
                    // 支払うべき額 (正の値)
                    amount: Math.round(-p.finalMoney)
                }));
            let receivers = Object.values(playerStats)
                .filter(p => p.finalMoney > 0)
                .map(p => ({
                    name: p.name,
                    // 受け取るべき額 (正の値)
                    amount: Math.round(p.finalMoney)
                }));

            // ... 既存の清算アルゴリズム (変更なし) ...
            let pIndex = 0;
            let rIndex = 0;

            // 支払いをマッチングする（最小回数での清算アルゴリズム）
            while (pIndex < payers.length && rIndex < receivers.length) {
                let payer = payers[pIndex];
                let receiver = receivers[rIndex];

                // 支払われる額は、支払い義務額と受取権利額の小さい方
                let payment = Math.min(payer.amount, receiver.amount);

                if (payment > 0) {
                    settlements.push({
                        from: payer.name,
                        to: receiver.name,
                        amount: payment
                    });
                }

                // 残額を更新
                payer.amount -= payment;
                receiver.amount -= payment;

                // 支払い義務/受取権利がなくなったプレイヤーのインデックスを進める
                if (payer.amount <= 0.5) {
                    pIndex++;
                }
                if (receiver.amount <= 0.5) {
                    rIndex++;
                }
            }

            const summaryContainer = document.getElementById('settlementSummary');
            if (settlements.length === 0) {
                summaryContainer.innerHTML = '<p class="text-gray-400 text-sm text-center py-2">清算の必要はありません (収支±0)</p>';
            } else {
                summaryContainer.innerHTML = settlements.map(s => `
                    <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg shadow-sm text-sm">
                        <div class="font-medium text-gray-700">${s.from}</div>
                        <div class="flex items-center text-green-700 font-bold">
                            <i class="fa-solid fa-arrow-right mx-2 text-green-500"></i>
                            ¥${s.amount.toLocaleString()}
                        </div>
                        <div class="font-medium text-gray-700">${s.to}へ</div>
                    </div>
                `).join('');
            }
        }

        // NEW: calculateDailyTotal のロジックを更新
        function calculateDailyTotal(sessions) {

            const today = new Date().toDateString();
            const todaySessions = sessions.filter(s => {
                // Firebaseのタイムスタンプが未定義の場合、ISO文字列を使うようにフォールバック
                let date;
                if (s.createdAt && typeof s.createdAt.toDate === 'function') {
                    date = new Date(s.createdAt.toDate());
                } else if (s.createdAt) { // ISO文字列の場合
                    date = new Date(s.createdAt);
                } else {
                    return false;
                }
                return date.toDateString() === today;
            });

            const playerStats = {};
            const totalGames = todaySessions.length;
            const feeMessageDisplay = document.getElementById('dailyFeeMessage');

            // 最初に設定された場代総額と支払い者を取得（その日のルールとして最新のものを使用）
            let latestFeeSetting = 0;
            let feePaidBy = '__everyone__';

            if (sessions.length > 0 && sessions[0].settings) {
                latestFeeSetting = parseInt(sessions[0].settings.fee) || 0;
                feePaidBy = sessions[0].settings.feePayer || '__everyone__';
            } else {
                // 履歴がない場合は現在の設定を使用
                latestFeeSetting = parseInt(document.getElementById('settingFee').value) || 0;
                feePaidBy = document.getElementById('settingFeePayer').value || '__everyone__';
            }

            const totalFeeDebit = latestFeeSetting;

            // プレイヤーの名前を特定するために、その日のセッションの結果を使用
            let uniquePlayers = new Set();
            if (todaySessions.length > 0) {
                todaySessions.forEach(session => {
                    session.results.forEach(r => uniquePlayers.add(r.name));
                });
            } else {
                // 履歴がゼロの場合、現在の入力名を使用
                players.forEach(p => uniquePlayers.add(p.name));
            }
            const playerCount = uniquePlayers.size > 0 ? uniquePlayers.size : 4;

            let feePerPlayer = 0;
            if (playerCount > 0) {
                feePerPlayer = totalFeeDebit / playerCount; // 割勘額
            }

            // 場代割勘メッセージの更新
            if (totalGames > 0 && totalFeeDebit > 0) {
                let payerMsg = feePaidBy === '__everyone__' ? '全員で割勘' : `${feePaidBy}さんが立て替えています`;
                feeMessageDisplay.textContent = `場代総額 ¥${totalFeeDebit.toLocaleString()}を${playerCount}名で割勘清算します (一人あたり ¥${Math.round(feePerPlayer).toLocaleString()})。支払い方法: ${payerMsg}`;
            } else {
                feeMessageDisplay.textContent = '';
            }

            // 1. 各局の成績を合算 (場代割勘前の合計)
            todaySessions.forEach(session => {
                session.results.forEach(r => {
                    if (!playerStats[r.name]) {
                        playerStats[r.name] = {
                            name: r.name,
                            totalPoint: 0,
                            rawMoney: 0, // 場代割勘前の合計
                            ranks: [0, 0, 0, 0],
                            games: 0
                        };
                    }
                    playerStats[r.name].totalPoint += (r.point || 0);
                    playerStats[r.name].rawMoney += (r.moneyPreFee || 0);
                    playerStats[r.name].games += 1;
                    if (r.rank >= 1 && r.rank <= 4) {
                        playerStats[r.name].ranks[r.rank - 1]++;
                    }
                });
            });

            // 2. 場代を割勘して最終収支を決定 (立て替えを考慮)
            const allPlayers = Array.from(uniquePlayers); // 全員をリストアップ

            allPlayers.forEach(pName => {
                if (!playerStats[pName]) {
                    // 一度も対局していないが、場代精算には含める必要があるプレイヤー
                    playerStats[pName] = {
                        name: pName,
                        totalPoint: 0,
                        rawMoney: 0,
                        ranks: [0, 0, 0, 0],
                        games: 0
                    };
                }

                const p = playerStats[pName];

                // (a) 全員が割勘額を負担 (負債)
                let feeAdjustment = -feePerPlayer;

                // (b) 立て替え者だった場合、負担した総額を回収する権利 (債権) を加算
                if (feePaidBy !== '__everyone__' && p.name === feePaidBy) {
                    // -feePerPlayer (負債) + totalFeeDebit (債権)
                    feeAdjustment += totalFeeDebit;
                }

                // 最終収支 = 場代割勘前の合計 + 調整額
                p.finalMoney = p.rawMoney + feeAdjustment;
            });


            // 3. 集計表示
            const container = document.getElementById('dailyTotalList');
            const finalPlayerStatsArray = Object.values(playerStats);

            if (finalPlayerStatsArray.length === 0 && todaySessions.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">本日の対局はまだありません</p>';
                renderSettlementSummary({});
                return;
            }

            // ポイント順にソート (対局者のみ)
            const sortedPlayers = finalPlayerStatsArray
                .filter(p => p.games > 0) // 対局したプレイヤーのみを成績に表示
                .sort((a, b) => b.totalPoint - a.totalPoint);

            // 対局者がいない場合 (場代清算だけ必要な場合)
            if (sortedPlayers.length === 0 && totalGames === 0 && finalPlayerStatsArray.length > 0) {
                // 対局がなくても場代清算が必要な場合は、全プレイヤーの精算サマリーは表示する
                container.innerHTML = '<p class="text-center text-gray-400 py-2">本日、成績を記録した対局はありません。</p>';
            } else if (sortedPlayers.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-4">データがありません</p>';
            } else {
                container.innerHTML = sortedPlayers.map((p, i) => {
                    const displayPoint = Math.round(p.totalPoint * 10) / 10;
                    const ptClass = displayPoint > 0 ? 'text-green-800 bg-green-100' : (displayPoint < 0 ? 'text-red-800 bg-red-100' : 'text-gray-600 bg-gray-100');
                    const avgRank = (p.ranks.reduce((sum, count, idx) => sum + count * (idx + 1), 0) / p.games).toFixed(2);

                    // 本日の成績欄は場代を含めない rawMoney を使用
                    const rawMoneyRounded = Math.round(p.rawMoney);

                    return `
                    <div class="flex items-center justify-between p-3 rounded-lg border border-gray-100 bg-white shadow-sm">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="font-bold text-gray-800">${p.name}</span>
                                <span class="text-xs px-2 py-0.5 rounded-full ${ptClass} font-bold">
                                    ${displayPoint > 0 ? '+' : ''}${displayPoint.toLocaleString()} P
                                </span>
                            </div>
                            <div class="flex text-xs text-gray-400 space-x-3">
                                <span>${p.games}戦</span>
                                <span>平均順位: ${avgRank}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="font-bold text-lg ${rawMoneyRounded >= 0 ? 'text-blue-600' : 'text-red-500'}">
                                ${rawMoneyRounded > 0 ? '+' : ''}${rawMoneyRounded.toLocaleString()}
                                <span class="text-xs font-normal text-gray-400">円</span>
                            </div>
                            <div class="text-xs text-gray-400 flex space-x-1 justify-end" title="順位回数: 1位 - 2位 - 3位 - 4位">
                                <span class="text-yellow-600 font-bold">${p.ranks[0]}</span>-
                                <span class="text-gray-700">${p.ranks[1]}</span>-
                                <span class="text-gray-700">${p.ranks[2]}</span>-
                                <span class="text-gray-600 font-bold">${p.ranks[3]}</span>
                            </div>
                        </div>
                    </div>
                    `;
                }).join('');
            }

            // 4. 清算サマリーの表示
            const statsForSettlement = {};
            finalPlayerStatsArray.forEach(p => {
                statsForSettlement[p.name] = p;
            });
            renderSettlementSummary(statsForSettlement);
        }

    </script>
</body>

</html>